# NW機器のconfigをCI/CDツールで扱ってみた

## インフラ自動化の次のフェーズ

Red Hat Ansible Automates 2023 Japanでは「インフラ自動化の次のフェーズは"コミュニケーションに注目した効率化"」とRed Hatが語っていました。
https://tracks.redhat.com/aa2023jpn/01_2023-07-20_automa?lx=tGsQE7
これまでの自動化は「作業」を効率化してくれるツールでしたが、これからはコミュニケーションコストの削減を目指します。

具体的にどういうことかというと、例えばACL穴あけ業務をイメージしてください。
これまではやってくる申請に基づき、人がconfigを作成してCLIで流し込んでいました。完了すればレポートを提出します。
このような業務を自動化した結果、作業者はパラメータの作成とAnsible playbookの実行、そして出力されるレポートの送信だけを担うようになりました。configの作成、流し込み、レポート起案はツールが自動でやってくれるのです。これが「作業の自動化」です。
それが、現在は申請者がUIに従いパラメータを入力して、ボタンを押せばAPIで先述のツールが実行される、というように変化を遂げています。
作業者を介する必要がなくなり、コミュニケーションコストが格段に削減されました。

## 我々が着目したのはConfig検証とレビューの効率化

上のACL穴あけの例では省略しましたが、プロジェクトによっては毎申請ごとにConfigの検証とレビューを行うこともあり、ここにもたくさんのコミュニケーションコストがかかっていることが想像できます。
なぜそんなにNWの設定変更には慎重になるのか。
これは少し古い記事ですが、Ciscoの技術者はNetDevOpsを迎え入れる必要性を説く際に、"Culture of Fear"という言葉を使っています。
https://blogs.cisco.com/developer/embrace-netdevops-part-1

NWの変更が慎重なのは日本だけじゃないんですね。

慎重なことは決して非難されるべきではありませんが、ビジネスがどんどん加速している状況でNWを迅速・柔軟に変更できないことは問題です。
このような文脈からNetDevOpsの思想は登場しました。

我々は今回、NetDevOpsの一環としてGithub Actionsを使用して、Configの検証とレビューを安全かつ効率的に行う方法に挑戦しました。

## ちょっとかっこつけすぎました

というのは後付けのもっともらしい理由で、きっかけはなんか楽しそうだからやってみたというのが本当のところです！

## このプロジェクトの重要なポイント

私たちが今回紹介する方法では、以下が重要なポイントです。

### 投入config - 合格基準 - 検証結果はversion管理され、1対1となる

投入configや合格基準をgit pushすることで検証が開始されるため、当然versionが管理されます。
そして、検証結果もversionに紐づきます。
つまり、検証でしばしば起こる「この結果はどのconfigのときのもの？」という辛い現象が起こらなくなります。

### 合格基準を満たして初めてレビューと承認が可能になる

合格基準を満たして初めてGithub上でpull requestが発行されます。
合格基準を満たすまでは差し止められ、pull requestが発行されないため、当然レビューも開始されません。

### Config検証における合格基準は全てcodeで定義されている

定性的な「XXができていること」のような基準ではなく、状態をjsonで取得し、queryした結果が想定と合致しているかを検査します。
つまり、設定された条件で要件を満たすことと、条件自体に誤りがないことをcodeを通して評価することがレビューとなるため、レビューはより厳格になります。

### レビューのトレーサビリティが向上します

pull requestをレビュアーがmergeすることをもってconfigの承認となります。
どの検証結果をもってconfigが承認されたかが明確になるため、トレーサビリティが向上します。

### 検証と同じ方法で本番に投入できます

configが自動で投入される仕組みは検証環境でも本番環境でも同一であるので、検証結果が真正に反映されます。

## DEMO

## 今後の展望
